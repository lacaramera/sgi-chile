{% extends "base.html" %}
{% block title %}Registro{% endblock %}
{% block content %}

<div class="max-w-2xl mx-auto bg-white rounded-2xl shadow p-6">
  <h2 class="text-2xl font-extrabold text-sky-800 mb-1">Crear cuenta</h2>
  <p class="text-sm text-gray-500 mb-6">
    Regístrate con tu RUT. Te enviaremos un correo para activar tu cuenta y crear tu contraseña.
  </p>

  {% if form.errors %}
    <div class="mb-4 p-3 rounded bg-red-50 text-red-700 text-sm">
      Revisa los campos. Hay errores en el formulario.
      <div class="mt-2 text-xs text-red-600">{{ form.errors }}</div>
    </div>
  {% endif %}

  <form method="post" class="space-y-4">
    {% csrf_token %}

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="text-sm font-semibold">RUT (será tu usuario)</label>
        {{ form.rut }}
      </div>

      <div>
        <label class="text-sm font-semibold">División</label>
        {{ form.division }}
      </div>

      <div>
        <label class="text-sm font-semibold">Nombre</label>
        {{ form.first_name }}
      </div>

      <div>
        <label class="text-sm font-semibold">Apellido</label>
        {{ form.last_name }}
      </div>

      <div class="md:col-span-2">
        <label class="text-sm font-semibold">Email</label>
        {{ form.email }}
      </div>

      <div>
        <label class="text-sm font-semibold">Fecha de nacimiento</label>
        {{ form.birth_date }}
      </div>

      <div>
        <label class="text-sm font-semibold">Fecha de ingreso (opcional)</label>
        {{ form.join_date }}
      </div>

      <div class="md:col-span-2">
        <label class="text-sm font-semibold">Dirección (opcional)</label>
        {{ form.address }}
      </div>
    </div>

    <!-- CASCADA: Sector -> Zona -> Grupo -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-2">
      <div class="md:col-span-2">
        <label class="text-sm font-semibold">Sector / Región</label>
        <select id="sectorSelect" class="w-full border border-gray-200 rounded-2xl px-4 py-2 text-sm">
          <option value="">— Selecciona sector —</option>
          {% for s in sectors %}
            <option value="{{ s.id }}">{{ s.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="text-sm font-semibold">Zona</label>
        <select id="zonaSelect" class="w-full border border-gray-200 rounded-2xl px-4 py-2 text-sm" disabled>
          <option value="">— Selecciona zona —</option>
        </select>
      </div>

      <div>
        <label class="text-sm font-semibold">Grupo</label>
        <!-- IMPORTANTE: name="group" (es el field real del ModelForm) -->
        <select name="group" id="grupoSelect" class="w-full border border-gray-200 rounded-2xl px-4 py-2 text-sm" disabled>
          <option value="">— Selecciona grupo —</option>
        </select>
        <p class="text-xs text-gray-500 mt-1">* Debes elegir Grupo para completar el registro.</p>
      </div>
    </div>

    <div class="pt-4 flex gap-3">
      <button class="px-5 py-2 rounded-lg bg-sky-700 text-white font-semibold">
        Registrarme
      </button>
      <a href="{% url 'login' %}" class="px-5 py-2 rounded-lg border">Volver</a>
    </div>
  </form>

  <div class="mt-6 text-sm text-gray-500">
    ¿Ya tienes cuenta?
    <a href="{% url 'login' %}" class="text-sky-700 font-semibold hover:underline">Inicia sesión</a>
  </div>
</div>

<script>
(function(){
  const sectorSelect = document.getElementById("sectorSelect");
  const zonaSelect = document.getElementById("zonaSelect");
  const grupoSelect = document.getElementById("grupoSelect");

  function resetZonas(){
    zonaSelect.innerHTML = '<option value="">— Selecciona zona —</option>';
    zonaSelect.disabled = true;
  }
  function resetGrupos(){
    grupoSelect.innerHTML = '<option value="">— Selecciona grupo —</option>';
    grupoSelect.disabled = true;
  }

  async function fetchJson(url){
    const r = await fetch(url, { headers: { "Accept": "application/json" } });
    const text = await r.text();
    if (!r.ok) {
      console.error("FETCH ERROR", r.status, url, text);
      throw new Error(`HTTP ${r.status}`);
    }
    try { return JSON.parse(text); }
    catch(e){ console.error("JSON PARSE ERROR", url, text); throw e; }
  }

  sectorSelect.addEventListener("change", async () => {
    const sectorId = sectorSelect.value;
    resetZonas(); resetGrupos();
    if (!sectorId) return;

    try{
      const data = await fetchJson(`/accounts/ajax/zonas/?sector_id=${sectorId}`);
      console.log("zonas response:", data);

      (data.zonas || []).forEach(z => {
        zonaSelect.insertAdjacentHTML("beforeend", `<option value="${z.id}">${z.name}</option>`);
      });
      zonaSelect.disabled = false;
    }catch(e){
      // deja el select deshabilitado, pero al menos verás el error
    }
  });

  zonaSelect.addEventListener("change", async () => {
    const zonaId = zonaSelect.value;
    resetGrupos();
    if (!zonaId) return;

    try{
      const data = await fetchJson(`/accounts/ajax/grupos/?zona_id=${zonaId}`);
      console.log("grupos response:", data);

      (data.grupos || []).forEach(g => {
        grupoSelect.insertAdjacentHTML("beforeend", `<option value="${g.id}">${g.name}</option>`);
      });
      grupoSelect.disabled = false;
    }catch(e){
    }
  });
})();
</script>


{% endblock %}
