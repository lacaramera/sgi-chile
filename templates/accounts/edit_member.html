{% extends "base.html" %}
{% block title %}Editar miembro{% endblock %}
{% block content %}

<div class="max-w-5xl mx-auto space-y-6">

  <!-- HEADER -->
  <div class="bg-white rounded-3xl shadow-sm px-8 py-5 border border-gray-100">
    <h1 class="text-2xl font-bold text-sky-800">Editar miembro</h1>
    <p class="text-sm text-gray-500">Actualiza datos y gestiona su hogar/familia.</p>
  </div>

  {% if messages %}
    <div class="space-y-2">
      {% for m in messages %}
        <div class="rounded-2xl px-4 py-3 text-sm
          {% if m.tags == 'success' %} bg-green-100 text-green-800 border border-green-200
          {% elif m.tags == 'error' %} bg-red-100 text-red-800 border border-red-200
          {% else %} bg-gray-100 text-gray-800 border border-gray-200 {% endif %}">
          {{ m }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- DATOS -->
  <div class="bg-white rounded-3xl shadow-md px-8 py-6 border border-gray-100">
    <h2 class="text-xl font-bold text-gray-800 mb-4">Datos</h2>

    <!-- FORM PRINCIPAL: SOLO GUARDAR DATOS DEL USUARIO -->
    <form method="post" class="space-y-4">
      {% csrf_token %}
      <input type="hidden" name="action" value="save_user"/>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

        <!-- Nombre -->
        <div>
          <label class="block text-sm font-semibold mb-1">Nombre</label>
          <input name="first_name" value="{{ member.first_name }}"
                 class="w-full rounded-2xl border border-gray-200 px-4 py-2"/>
        </div>

        <!-- Apellido -->
        <div>
          <label class="block text-sm font-semibold mb-1">Apellido</label>
          <input name="last_name" value="{{ member.last_name }}"
                 class="w-full rounded-2xl border border-gray-200 px-4 py-2"/>
        </div>

        <!-- Email -->
        <div>
          <label class="block text-sm font-semibold mb-1">Email</label>
          <input name="email" value="{{ member.email }}"
                 class="w-full rounded-2xl border border-gray-200 px-4 py-2"/>
        </div>

        <!-- Rol -->
        <div>
          <label class="block text-sm font-semibold mb-1">Rol</label>
          <select name="role" class="w-full rounded-2xl border border-gray-200 px-4 py-2">
            {% for val, label in role_choices %}
              <option value="{{ val }}" {% if member.role == val %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- División -->
        <div>
          <label class="block text-sm font-semibold mb-1">División</label>
          <select name="division" class="w-full rounded-2xl border border-gray-200 px-4 py-2">
            <option value="" {% if not member.division %}selected{% endif %}>— Sin división —</option>
            <option value="djm" {% if member.division == "djm" %}selected{% endif %}>DJM</option>
            <option value="djf" {% if member.division == "djf" %}selected{% endif %}>DJF</option>
            <option value="caballeros" {% if member.division == "caballeros" %}selected{% endif %}>Caballeros</option>
            <option value="damas" {% if member.division == "damas" %}selected{% endif %}>Damas</option>
          </select>
        </div>

        <!-- RN / Vice RN -->
        <div class="md:col-span-2 flex flex-wrap items-center gap-6">
          <label class="flex items-center gap-2">
            <input id="is_division_national_leader" type="checkbox"
                   name="is_division_national_leader"
                   {% if member.is_division_national_leader %}checked{% endif %}
                   class="h-4 w-4"/>
            <span class="text-sm font-semibold">Responsable nacional</span>
          </label>

          <label class="flex items-center gap-2">
            <input id="is_division_national_vice" type="checkbox"
                   name="is_division_national_vice"
                   {% if member.is_division_national_vice %}checked{% endif %}
                   class="h-4 w-4"/>
            <span class="text-sm font-semibold">Vice responsable nacional</span>
          </label>
        </div>

        <!-- División nacional -->
        <div class="md:col-span-2" id="nationalDivisionWrap">
          <label class="block text-sm font-semibold mb-1">División nacional que lidera</label>
          <select name="national_division" id="nationalDivisionSelect"
                  class="w-full rounded-2xl border border-gray-200 px-4 py-2">
            <option value="" {% if not member.national_division %}selected{% endif %}>— Selecciona —</option>
            <option value="djm" {% if member.national_division == "djm" %}selected{% endif %}>DJM</option>
            <option value="djf" {% if member.national_division == "djf" %}selected{% endif %}>DJF</option>
            <option value="caballeros" {% if member.national_division == "caballeros" %}selected{% endif %}>Caballeros</option>
            <option value="damas" {% if member.national_division == "damas" %}selected{% endif %}>Damas</option>
          </select>

          <p class="text-xs text-gray-500 mt-1">* Solo aplica si marcaste Responsable/Vice nacional.</p>

          <div id="nationalDivisionError"
               class="hidden mt-2 text-xs font-semibold text-red-600">
            Debes elegir la división nacional.
          </div>
        </div>

        <!-- Dirección -->
        <div class="md:col-span-2">
          <label class="block text-sm font-semibold mb-1">Dirección</label>
          <input name="address" value="{{ member.address }}"
                 class="w-full rounded-2xl border border-gray-200 px-4 py-2"/>
        </div>

        <!-- Fechas -->
        <div>
          <label class="block text-sm font-semibold mb-1">Nacimiento</label>
          <input type="date" name="birth_date"
                 value="{{ member.birth_date|date:'Y-m-d' }}"
                 class="w-full rounded-2xl border border-gray-200 px-4 py-2"/>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Ingreso</label>
          <input type="date" name="join_date"
                 value="{{ member.join_date|date:'Y-m-d' }}"
                 class="w-full rounded-2xl border border-gray-200 px-4 py-2"/>
        </div>

        <!-- Único miembro familia -->
        <div class="flex items-center gap-2 md:col-span-2">
          <input id="is_only_family_member" type="checkbox" name="is_only_family_member"
                 {% if member.is_only_family_member %}checked{% endif %}
                 class="h-4 w-4"/>
          <label for="is_only_family_member" class="text-sm font-semibold">
            Único miembro de su familia
          </label>
        </div>

        <!-- ====== Encadenado: Sector -> Zona -> Grupo ====== -->
        <div>
          <label class="block text-sm font-semibold mb-1">Sector / Región</label>
          <select id="sectorSelect" class="w-full rounded-2xl border border-gray-200 px-4 py-2">
            <option value="">— Selecciona sector —</option>
            {% for s in sectors %}
              <option value="{{ s.id }}" {% if member_sector_id == s.id %}selected{% endif %}>
                {{ s.name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Zona</label>
          <select id="zonaSelect" class="w-full rounded-2xl border border-gray-200 px-4 py-2" disabled>
            <option value="">— Selecciona zona —</option>
          </select>
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm font-semibold mb-1">Grupo</label>
          <!-- ESTE ES EL ÚNICO QUE SE GUARDA EN BD -->
          <select name="group_id" id="grupoSelect"
                  class="w-full rounded-2xl border border-gray-200 px-4 py-2" disabled>
            <option value="">— Selecciona grupo —</option>
          </select>
          <p class="text-xs text-gray-500 mt-1">
            * Elegir Grupo asigna automáticamente Zona y Sector.
          </p>
        </div>
        <!-- =============================================== -->

        <!-- Activo -->
        <div class="flex items-center gap-2 md:col-span-2">
          <input id="is_active" type="checkbox" name="is_active"
                 {% if member.is_active %}checked{% endif %}
                 class="h-4 w-4"/>
          <label for="is_active" class="text-sm font-semibold">Activo</label>
        </div>

        <!-- Info -->
        <div class="text-sm text-gray-500 md:col-span-2">
          <div><span class="font-semibold">Usuario:</span> {{ member.username }}</div>
          <div><span class="font-semibold">ID:</span> {{ member.id }}</div>
        </div>

      </div>

      <div class="pt-2">
        <button type="submit"
                class="px-8 py-2 rounded-full bg-blue-600 text-white font-semibold hover:bg-blue-700">
          Guardar cambios
        </button>
      </div>

    </form>
    <!-- FIN FORM PRINCIPAL -->
  </div>

  <!-- HOGAR / FAMILIA (FUERA DEL FORM PRINCIPAL PARA EVITAR FORM ANIDADO) -->
  <div class="bg-white rounded-3xl shadow-md px-8 py-6 border border-gray-100">
    <div class="flex items-center justify-between gap-4">
      <div>
        <h2 class="text-xl font-bold text-gray-800">Hogar / Familia</h2>
        <p class="text-sm text-gray-500">Crea hogar y agrega/quita miembros.</p>
      </div>

      {% if not household %}
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="action" value="create_household"/>
          <button class="px-5 py-2 rounded-full bg-sky-700 text-white font-semibold hover:bg-sky-800">
            Crear hogar
          </button>
        </form>
      {% else %}
        <div class="text-sm text-gray-600">
          <span class="font-semibold">Hogar:</span> {{ household }}
        </div>
      {% endif %}
    </div>

    {% if household %}
      <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">

        <!-- LISTA MIEMBROS -->
        <div>
          <h3 class="text-base font-bold text-gray-800 mb-3">Miembros del hogar</h3>

          {% if memberships %}
            <div class="space-y-2">
              {% for m in memberships %}
                <div class="flex items-center justify-between gap-3 rounded-2xl border border-gray-200 px-4 py-3">
                  <div class="text-sm">
                    <div class="font-semibold text-gray-900">
                      {{ m.user.first_name }} {{ m.user.last_name }}
                      {% if m.is_primary %}
                        <span class="ml-2 text-xs px-2 py-1 rounded-full bg-amber-100 text-amber-800">Principal</span>
                      {% endif %}
                    </div>
                    <div class="text-xs text-gray-500">
                      {{ m.user.username }} • {{ m.get_relationship_display }}
                    </div>
                  </div>

                  {% if not m.is_primary %}
                    <form method="post">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="remove_from_household"/>
                      <input type="hidden" name="membership_id" value="{{ m.id }}"/>
                      <button class="px-4 py-2 rounded-xl border border-red-200 text-red-700 hover:bg-red-50 text-sm font-semibold">
                        Quitar
                      </button>
                    </form>
                  {% else %}
                    <span class="text-xs text-gray-400">No se puede quitar</span>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-sm text-gray-500">No hay miembros en este hogar.</p>
          {% endif %}
        </div>

        <!-- AGREGAR MIEMBROS -->
        <div>
          <h3 class="text-base font-bold text-gray-800 mb-3">Agregar miembro</h3>

          <form method="get" class="flex gap-2 mb-4">
            <input name="q" value="{{ q }}" placeholder="Buscar por username / nombre / apellido"
                   class="w-full rounded-2xl border border-gray-200 px-4 py-2 text-sm"/>
            <button type="submit"
                    class="px-4 py-2 rounded-2xl border font-semibold text-sm hover:bg-gray-50">
              Buscar
            </button>
          </form>

          {% if q and candidates %}
            <div class="space-y-2">
              {% for c in candidates %}
                <form method="post" class="rounded-2xl border border-gray-200 px-4 py-3">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="add_to_household"/>
                  <input type="hidden" name="add_user_id" value="{{ c.id }}"/>

                  <div class="flex items-start justify-between gap-3">
                    <div class="text-sm">
                      <div class="font-semibold text-gray-900">{{ c.first_name }} {{ c.last_name }}</div>
                      <div class="text-xs text-gray-500">{{ c.username }}</div>
                    </div>

                    <div class="flex items-center gap-2">
                      <select name="relationship" class="rounded-xl border border-gray-200 px-3 py-2 text-sm">
                        {% for val, label in rel_choices %}
                          <option value="{{ val }}">{{ label }}</option>
                        {% endfor %}
                      </select>

                      <button type="submit"
                              class="px-4 py-2 rounded-xl bg-green-600 text-white font-semibold text-sm hover:bg-green-700">
                        Agregar
                      </button>
                    </div>
                  </div>
                </form>
              {% endfor %}
            </div>
          {% elif q %}
            <p class="text-sm text-gray-500">Sin resultados para “{{ q }}”.</p>
          {% else %}
            <p class="text-sm text-gray-500">Busca un usuario para agregarlo al hogar.</p>
          {% endif %}

          <p class="text-xs text-gray-400 mt-3">
            * Si el usuario ya pertenece a otro hogar, el sistema lo rechazará (como en tu view).
          </p>
        </div>

      </div>
    {% endif %}
  </div>

</div>

<script>
(function(){
  // ======================
  // 1) Encadenado Sector/Zona/Grupo
  // ======================
  const sectorSelect = document.getElementById("sectorSelect");
  const zonaSelect   = document.getElementById("zonaSelect");
  const grupoSelect  = document.getElementById("grupoSelect");

  const preSector = "{{ member_sector_id|default:'' }}";
  const preZona   = "{{ member_zona_id|default:'' }}";
  const preGrupo  = "{{ member.group_id|default:'' }}";

  function fillSelect(selectEl, items, placeholder) {
    selectEl.innerHTML = "";
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = placeholder;
    selectEl.appendChild(opt);

    (items || []).forEach(it => {
      const o = document.createElement("option");
      o.value = it.id;
      o.textContent = it.name;
      selectEl.appendChild(o);
    });
  }

  function loadZonas(sectorId, selectedZonaId = "") {
    fillSelect(zonaSelect, [], "— Selecciona zona —");
    fillSelect(grupoSelect, [], "— Selecciona grupo —");
    zonaSelect.disabled = true;
    grupoSelect.disabled = true;

    if (!sectorId) return;

    fetch(`/accounts/ajax/zonas/?sector_id=${sectorId}`)
      .then(r => r.json())
      .then(data => {
        fillSelect(zonaSelect, data.zonas || [], "— Selecciona zona —");
        zonaSelect.disabled = false;
        if (selectedZonaId) zonaSelect.value = selectedZonaId;
      });
  }

  function loadGrupos(zonaId, selectedGrupoId = "") {
    fillSelect(grupoSelect, [], "— Selecciona grupo —");
    grupoSelect.disabled = true;

    if (!zonaId) return;

    fetch(`/accounts/ajax/grupos/?zona_id=${zonaId}`)
      .then(r => r.json())
      .then(data => {
        fillSelect(grupoSelect, data.grupos || [], "— Selecciona grupo —");
        grupoSelect.disabled = false;
        if (selectedGrupoId) grupoSelect.value = selectedGrupoId;
      });
  }

  if (sectorSelect && zonaSelect && grupoSelect) {
    sectorSelect.addEventListener("change", () => {
      loadZonas(sectorSelect.value);
    });

    zonaSelect.addEventListener("change", () => {
      loadGrupos(zonaSelect.value);
    });

    // Precarga
    if (preSector) {
      sectorSelect.value = preSector;
      loadZonas(preSector, preZona);
      if (preZona) setTimeout(() => loadGrupos(preZona, preGrupo), 200);
    }
  }

  // ======================
  // 2) RN / Vice RN: mostrar/ocultar + validar
  // ======================
  const leader = document.getElementById("is_division_national_leader");
  const vice = document.getElementById("is_division_national_vice");
  const wrap = document.getElementById("nationalDivisionWrap");
  const select = document.getElementById("nationalDivisionSelect");
  const error = document.getElementById("nationalDivisionError");

  // OJO: este form ahora sí es solo el principal
  const form = document.querySelector('form[method="post"] input[name="action"][value="save_user"]')?.closest('form');

  if (!leader || !vice || !wrap || !select || !form) return;

  function syncNational(){
    const on = leader.checked || vice.checked;
    wrap.style.display = on ? "" : "none";
    if (!on) {
      select.value = "";
      if (error) error.classList.add("hidden");
    }
  }

  leader.addEventListener("change", () => {
    if (leader.checked) vice.checked = false;
    syncNational();
  });

  vice.addEventListener("change", () => {
    if (vice.checked) leader.checked = false;
    syncNational();
  });

  form.addEventListener("submit", (e) => {
    if ((leader.checked || vice.checked) && !select.value) {
      e.preventDefault();
      if (error) error.classList.remove("hidden");
      select.focus();
    }
  });

  syncNational();
})();
</script>

{% endblock %}
