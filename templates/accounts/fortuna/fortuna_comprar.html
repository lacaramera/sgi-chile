{% extends "base.html" %}
{% load static %}
{% block title %}Comprar Fortuna{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-6">

  <!-- Header -->
  <div class="bg-white rounded-3xl shadow-sm px-8 py-5 border border-gray-100 flex items-start justify-between gap-4">
    <div>
      <h1 class="text-2xl font-bold text-sky-800">Revista Fortuna</h1>

      {% if issue %}
        <p class="text-sm text-gray-500 mt-1">
          Solicitud de compra para la edición:
          <b>
            {% if issue.title %}
              {{ issue.title }}
            {% else %}
              {{ issue.code }}
            {% endif %}
          </b>
          — Valor:
          <b>${{ price_clp|default:"4.000" }}</b>
        </p>
      {% else %}
        <p class="text-sm text-gray-500 mt-1">Aún no hay una edición activa configurada.</p>
      {% endif %}
    </div>

    <!-- Acciones (derecha) -->
    <div class="flex items-center gap-2">
      <!-- Volver (chico, no rompe el layout) -->
      <a href="{% url 'fortuna_home' %}"
         class="inline-flex items-center gap-2 px-5 py-2 rounded-full bg-sky-600 text-white text-sm font-semibold hover:bg-sky-700">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
        Volver
      </a>

      {% if user.is_superuser or user.role == 'admin' or user.role == 'directiva' %}
        <a href="{% url 'fortuna_admin_purchases' %}"
           class="inline-flex items-center gap-2 px-5 py-2 rounded-full bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-700">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path d="M7 3h10v18H7z"/>
            <path d="M9 7h6"/>
            <path d="M9 11h6"/>
            <path d="M9 15h6"/>
          </svg>
          Revisar solicitudes
        </a>
      {% endif %}
    </div>
  </div>

  {% if already_approved %}
    <div class="bg-green-100 border border-green-300 text-green-800 px-4 py-3 rounded-xl">
      ✅ Actualmente tienes acceso hasta: {{ purchase.access_end }}. Puedes renovar ahora para asegurar el próximo período.
    </div>
    {% endif %}

  {% if success %}
    <div class="bg-green-100 border border-green-300 text-green-800 px-4 py-3 rounded-xl">
      ✅ Solicitud enviada correctamente. Un administrador revisará tu comprobante y te dará acceso cuando esté aprobada.
    </div>
  {% endif %}

  {% if previous_status == "rejected" %}
    <div class="bg-red-100 border border-red-300 text-red-800 px-4 py-3 rounded-xl">
      ❌ Tu solicitud fue rechazada.
      {% if reject_reason %}
        <div class="text-sm mt-1"><b>Motivo:</b> {{ reject_reason }}</div>
      {% endif %}
      <div class="text-sm mt-1">Puedes reenviar una nueva solicitud corrigiendo el comprobante/fecha.</div>
    </div>
  {% endif %}

  {% if not issue %}
    <div class="bg-white rounded-3xl shadow-sm px-8 py-6 border border-gray-100">
      <p class="text-gray-700">
        Cuando exista una edición activa, aquí podrás solicitar tu compra subiendo tu comprobante.
      </p>
    </div>
  {% else %}

  <!-- 2 columnas: Datos / Formulario -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">

    <!-- Card: Datos para depósito -->
    <div class="bg-white rounded-3xl shadow-sm border border-gray-100 px-8 py-8">
      <div class="mb-6">
        <span class="inline-flex items-center gap-2 px-5 py-2 rounded-full bg-sky-600 text-white text-sm font-semibold">
          <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-white/20">
            <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7">
              <path d="M12 3l8 4v5c0 5-3.5 9-8 9s-8-4-8-9V7z"/>
              <path d="M9 14l2 2 4-4"/>
            </svg>
          </span>
          Datos para depósito
        </span>
      </div>

      <h2 class="text-3xl font-extrabold text-sky-700 leading-tight">
        Corporación Soka Gakkai<br/>
        Internacional de Chile
      </h2>

      <div class="mt-6 space-y-2 text-lg text-gray-800">
        <p><span class="font-semibold">Rut:</span> 71.029.900-5</p>
        <p><span class="font-semibold">Banco:</span> Scotiabank</p>
        <p><span class="font-semibold">Tipo de cuenta:</span> Cuenta corriente</p>
        <p><span class="font-semibold">Número de cuenta:</span> 985455481</p>
        <p class="pt-2"><span class="font-semibold">Correo:</span> libreria.sgich@gmail.com</p>
        <p class="pt-2"><span class="font-semibold">Monto:</span> ${{ price_clp|default:"4.000" }}</p>
      </div>
    </div>

    <!-- Card: Formulario -->
    <div class="space-y-6">

      <!-- Bloque rojo info -->
      <div class="bg-red-500 text-white rounded-3xl shadow-md px-8 py-6 border border-red-600">
        <h2 class="text-2xl font-bold mb-3">Solicitar compra</h2>
        <ul class="list-disc pl-6 space-y-1 text-sm md:text-base">
          <li>Adjunta tu comprobante de depósito para que un administrador valide tu compra.</li>
          <li>Una vez aprobada tu solicitud, tendrás acceso al material digital de la edición del mes siguiente en adelante.</li>
          <li>Si necesitas ayuda, contacta soporte (+569 5049 4019).</li>
        </ul>
      </div>

      {% if issue %}
      <form method="post" enctype="multipart/form-data" class="space-y-6">
        {% csrf_token %}

        

        {% if other_mode %}
        <input type="hidden" name="__other_mode" value="1">

        <label class="block text-sm font-semibold">Informar para</label>
        <select name="report_for_user_id" class="w-full rounded-xl">
          {% for m in scope_users %}
            <option value="{{ m.id }}" {% if target_user.id == m.id %}selected{% endif %}>
              {{ m.first_name }} {{ m.last_name }}
            </option>
          {% endfor %}
        </select>

        {% endif %}


        
       


        <!-- Barra azul con inputs -->
        <div class="bg-gradient-to-r from-sky-600 to-cyan-500 rounded-3xl px-8 py-6 text-white shadow-lg space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">

            <!-- Plan -->
            <div>
              <label class="block text-sm font-semibold mb-1">Plan</label>
              <select name="plan" class="w-full rounded-full px-4 py-2 text-gray-900">
                <option value="">Selecciona...</option>
                <option value="trim" {% if selected_plan == "trim" %}selected{% endif %}>
                  Trimestral — $12.000
                </option>
                <option value="sem" {% if selected_plan == "sem" %}selected{% endif %}>
                  Semestral — $24.000
                </option>
                <option value="anual" {% if selected_plan == "anual" %}selected{% endif %}>
                  Anual — $48.000
                </option>
              </select>

              {% if errors.plan %}
                <p class="text-xs text-red-100 mt-1">{{ errors.plan }}</p>
              {% endif %}
            </div>

            <!-- Fecha -->
            <div>
              <label class="block text-sm font-semibold mb-1">Fecha de depósito</label>
              <input type="date"
                     name="deposit_date"
                     value="{{ date_value }}"
                     class="w-full rounded-full px-4 py-2 text-gray-900">
              {% if errors.deposit_date %}
                <p class="text-xs text-red-100 mt-1">{{ errors.deposit_date }}</p>
              {% endif %}
            </div>

            <!-- Comprobante -->
            <div>
              <label class="block text-sm font-semibold mb-1">Comprobante de depósito</label>
              <input type="file"
                     name="receipt"
                     accept="image/*,application/pdf"
                     class="w-full rounded-full px-4 py-1.5 text-gray-900 bg-white">
              {% if errors.receipt %}
                <p class="text-xs text-red-100 mt-1">{{ errors.receipt }}</p>
              {% endif %}
            </div>
          </div>

          <!-- Comentario -->
          <div>
            <label class="block text-sm font-semibold mb-1">Comentario (opcional)</label>
            <textarea name="note"
                      rows="2"
                      class="w-full rounded-xl px-3 py-2 text-gray-900"
                      placeholder="Ej: Deposité desde la cuenta de X / referencia..."
            >{{ note_value }}</textarea>
          </div>
        </div>

        <!-- Botón -->
        <div class="flex justify-center">
          <button type="submit"
                  class="px-10 py-2 rounded-full bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700">
            Enviar solicitud
          </button>
        </div>
      </form>
      {% endif %}

    </div>
  </div>

  {% endif %}
</div>
{% endblock %}
